<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POKO ‚Äî Control Room</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;600;700;900&display=swap" rel="stylesheet">
<script src="auth.js"></script>
<style>
:root{
  /* Bichromatique : Noir charbon + Rouge casino */
  --amber:#e63946; --amber-dim:rgba(230,57,70,.12); --amber-glow:rgba(230,57,70,.35);
  --red:#ff6b6b; --red-dim:rgba(255,107,107,.15);
  --green:#e63946; --green-dim:rgba(230,57,70,.1);
  --blue:#c9184a; --blue-dim:rgba(201,24,74,.12);
  --purple:#ff4d6d;
  --bg:#0a0a0a; --panel:#111111; --panel2:#181818; --border:rgba(230,57,70,.18);
  --text:rgba(255,210,210,.88); --text-dim:rgba(255,180,180,.35);
  /* Accent secondaire : blanc cass√© */
  --white:#f8f0f0; --accent2:#1a1a1a;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);font-family:'Share Tech Mono',monospace;color:var(--text);}

/* Scanlines */
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 3px,rgba(0,0,0,.08) 3px,rgba(0,0,0,.08) 4px);pointer-events:none;z-index:200;}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.shell{display:flex;height:100vh;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{
  width:220px;flex-shrink:0;
  background:var(--panel);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  overflow:hidden;
}
.sidebar-logo{
  padding:20px 16px 16px;
  border-bottom:1px solid var(--border);
}
.logo-text{font-family:'Orbitron',monospace;font-size:18px;font-weight:900;color:var(--amber);letter-spacing:6px;text-shadow:0 0 15px var(--amber-glow);}
.logo-sub{font-size:8px;letter-spacing:3px;color:var(--text-dim);margin-top:3px;text-transform:uppercase;}
.system-status{
  margin:12px 16px;padding:8px 10px;
  background:var(--amber-dim);border:1px solid rgba(230,57,70,.25);
  border-radius:2px;font-size:9px;letter-spacing:2px;color:var(--amber);
  display:flex;align-items:center;gap:6px;
}
.status-dot{width:6px;height:6px;border-radius:50%;background:var(--amber);animation:pulse 2s infinite;flex-shrink:0;}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(230,57,70,.5)}50%{opacity:.7;box-shadow:0 0 0 4px rgba(230,57,70,0)}}

.nav-section{padding:8px 0;}
.nav-label{font-size:8px;letter-spacing:3px;color:var(--text-dim);padding:6px 16px 4px;text-transform:uppercase;}
.nav-item{
  display:flex;align-items:center;gap:10px;
  padding:10px 16px;cursor:pointer;
  font-size:11px;letter-spacing:1px;
  color:var(--text-dim);transition:all .15s;
  border-left:2px solid transparent;
  text-transform:uppercase;
}
.nav-item:hover{color:var(--text);background:rgba(255,179,0,.04);}
.nav-item.active{color:var(--amber);border-left-color:var(--amber);background:var(--amber-dim);}
.nav-icon{font-size:14px;width:18px;text-align:center;flex-shrink:0;}
.nav-badge{margin-left:auto;background:var(--red);color:#fff;font-size:8px;padding:2px 5px;border-radius:2px;}

.sidebar-footer{
  margin-top:auto;padding:14px 16px;
  border-top:1px solid var(--border);
  font-size:9px;color:var(--text-dim);letter-spacing:1px;
}
.logout-btn{width:100%;padding:8px;background:transparent;border:1px solid rgba(255,51,51,.3);color:rgba(255,51,51,.6);font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;cursor:pointer;transition:all .2s;margin-top:8px;text-transform:uppercase;}
.logout-btn:hover{border-color:var(--red);color:var(--red);background:var(--red-dim);}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{flex:1;overflow-y:auto;display:flex;flex-direction:column;}
.main::-webkit-scrollbar{width:4px;}
.main::-webkit-scrollbar-thumb{background:rgba(255,179,0,.2);border-radius:2px;}

.topbar{
  height:52px;flex-shrink:0;
  background:var(--panel);border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 24px;
  position:sticky;top:0;z-index:50;
}
.topbar-title{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;color:var(--amber);letter-spacing:4px;}
.topbar-time{font-size:11px;color:var(--text-dim);letter-spacing:2px;}
.topbar-clock{color:var(--amber);}

.content{padding:24px;flex:1;}

/* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
.panel{display:none;animation:fadeIn .3s ease;}
.panel.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:14px;margin-bottom:24px;}
.kpi{
  background:var(--panel);border:1px solid var(--border);
  padding:18px 20px;position:relative;overflow:hidden;
}
.kpi::after{content:'';position:absolute;top:0;left:0;width:3px;height:100%;background:var(--amber);}
.kpi.green::after{background:#e63946;}
.kpi.red::after{background:var(--red);}
.kpi.blue::after{background:#c9184a;}
.kpi-label{font-size:8px;letter-spacing:3px;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px;}
.kpi-val{font-family:'Orbitron',monospace;font-size:24px;font-weight:700;color:var(--amber);letter-spacing:2px;}
.kpi.green .kpi-val{color:var(--green);}
.kpi.red .kpi-val{color:var(--red);}
.kpi.blue .kpi-val{color:var(--blue);}
.kpi-sub{font-size:9px;color:var(--text-dim);margin-top:4px;letter-spacing:1px;}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px;}
@media(max-width:900px){.grid2{grid-template-columns:1fr;}}

.card{background:var(--panel);border:1px solid var(--border);padding:20px;}
.card-title{
  font-size:9px;letter-spacing:4px;color:var(--text-dim);
  text-transform:uppercase;margin-bottom:16px;padding-bottom:10px;
  border-bottom:1px solid rgba(255,179,0,.08);
  display:flex;align-items:center;justify-content:space-between;
}
.card-title span{color:var(--amber);}

/* Activity feed */
.feed{max-height:220px;overflow-y:auto;}
.feed::-webkit-scrollbar{width:2px;}
.feed::-webkit-scrollbar-thumb{background:rgba(255,179,0,.2);}
.feed-item{display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid rgba(255,179,0,.05);font-size:11px;}
.feed-item:last-child{border-bottom:none;}
.feed-time{color:var(--text-dim);flex-shrink:0;font-size:10px;}
.feed-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.feed-dot.win{background:var(--green);}
.feed-dot.lose{background:var(--red);}
.feed-dot.join{background:var(--blue);}
.feed-dot.warn{background:var(--amber);}
.feed-text{color:var(--text);}

/* Bar chart */
.bar-chart{display:flex;align-items:flex-end;gap:6px;height:100px;margin-top:8px;}
.bar-col{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;}
.bar{width:100%;background:linear-gradient(180deg,var(--amber) 0%,rgba(255,179,0,.3) 100%);border-radius:2px 2px 0 0;min-height:4px;transition:height .5s ease;}
.bar-lbl{font-size:8px;color:var(--text-dim);letter-spacing:1px;}
.bar-val{font-size:8px;color:var(--amber);}

/* ‚îÄ‚îÄ PLAYERS TABLE ‚îÄ‚îÄ */
.players-toolbar{display:flex;gap:10px;align-items:center;margin-bottom:16px;flex-wrap:wrap;}
.search-input{
  flex:1;min-width:180px;padding:8px 12px;
  background:var(--panel2);border:1px solid var(--border);
  color:var(--text);font-family:'Share Tech Mono',monospace;font-size:12px;
  outline:none;transition:border-color .2s;
}
.search-input:focus{border-color:rgba(255,179,0,.5);}
.search-input::placeholder{color:var(--text-dim);}
.filter-btn{
  padding:8px 14px;background:transparent;border:1px solid var(--border);
  color:var(--text-dim);font-family:'Share Tech Mono',monospace;font-size:10px;
  cursor:pointer;transition:all .15s;letter-spacing:1px;text-transform:uppercase;white-space:nowrap;
}
.filter-btn:hover,.filter-btn.active{border-color:var(--amber);color:var(--amber);background:var(--amber-dim);}

.players-table{width:100%;border-collapse:collapse;}
.players-table th{
  font-size:8px;letter-spacing:3px;color:var(--text-dim);
  text-transform:uppercase;padding:8px 12px;text-align:left;
  border-bottom:1px solid rgba(255,179,0,.1);
}
.players-table td{padding:11px 12px;font-size:12px;border-bottom:1px solid rgba(255,179,0,.04);}
.players-table tr:hover td{background:rgba(255,179,0,.03);}
.status-badge{
  display:inline-block;padding:2px 8px;font-size:9px;letter-spacing:2px;border-radius:1px;
}
.status-badge.active{background:var(--green-dim);color:var(--green);border:1px solid rgba(0,230,118,.25);}
.status-badge.banned{background:var(--red-dim);color:var(--red);border:1px solid rgba(255,51,51,.25);}
.status-badge.vip{background:rgba(198,120,255,.12);color:var(--purple);border:1px solid rgba(198,120,255,.25);}
.action-btn{
  padding:4px 10px;background:transparent;border:1px solid;
  font-family:'Share Tech Mono',monospace;font-size:9px;cursor:pointer;
  letter-spacing:1px;transition:all .15s;text-transform:uppercase;margin-right:4px;
}
.action-btn.ban{border-color:rgba(255,51,51,.4);color:rgba(255,51,51,.7);}
.action-btn.ban:hover{background:var(--red-dim);color:var(--red);}
.action-btn.unban{border-color:rgba(0,230,118,.4);color:rgba(0,230,118,.7);}
.action-btn.unban:hover{background:var(--green-dim);color:var(--green);}
.action-btn.view{border-color:rgba(0,180,255,.4);color:rgba(0,180,255,.7);}
.action-btn.view:hover{background:var(--blue-dim);color:var(--blue);}
.action-btn.vip{border-color:rgba(198,120,255,.4);color:rgba(198,120,255,.7);}
.action-btn.vip:hover{background:rgba(198,120,255,.1);color:var(--purple);}

/* ‚îÄ‚îÄ RTP CONTROL ‚îÄ‚îÄ */
.rtp-header{
  background:rgba(255,51,51,.06);border:1px solid rgba(255,51,51,.2);
  padding:14px 18px;margin-bottom:20px;
  display:flex;align-items:center;gap:12px;
}
.rtp-warning{font-size:10px;color:rgba(255,150,50,.8);letter-spacing:1px;line-height:1.7;}
.rtp-warning strong{color:var(--amber);}

.rtp-global{background:var(--panel);border:1px solid var(--border);padding:20px;margin-bottom:20px;}
.rtp-global-title{font-size:9px;letter-spacing:4px;color:var(--text-dim);text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;}
.rtp-preset-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;}
.rtp-preset{
  padding:8px 16px;border:1px solid var(--border);background:transparent;
  color:var(--text-dim);font-family:'Share Tech Mono',monospace;font-size:10px;
  cursor:pointer;transition:all .2s;letter-spacing:1px;text-transform:uppercase;
}
.rtp-preset:hover{border-color:var(--amber);color:var(--amber);}
.rtp-preset.p-neutre{} 
.rtp-preset.p-fav:hover,.rtp-preset.p-fav.on{border-color:var(--green);color:var(--green);background:var(--green-dim);}
.rtp-preset.p-defav:hover,.rtp-preset.p-defav.on{border-color:var(--amber);color:var(--amber);background:var(--amber-dim);}
.rtp-preset.p-ruine:hover,.rtp-preset.p-ruine.on{border-color:var(--red);color:var(--red);background:var(--red-dim);}
.rtp-preset.p-neutre:hover,.rtp-preset.p-neutre.on{border-color:var(--blue);color:var(--blue);background:var(--blue-dim);}

/* Slider style machine √† sous */
.rtp-players{display:flex;flex-direction:column;gap:16px;}
.rtp-player-row{
  background:var(--panel);border:1px solid var(--border);padding:16px 20px;
  display:flex;align-items:center;gap:20px;flex-wrap:wrap;
}
.rtp-player-name{min-width:130px;font-size:12px;color:var(--text);letter-spacing:1px;}
.rtp-player-name .you-tag{color:var(--amber);font-size:9px;margin-left:5px;}
.rtp-slider-wrap{flex:1;min-width:200px;}
.rtp-label-row{display:flex;justify-content:space-between;font-size:8px;color:var(--text-dim);letter-spacing:2px;margin-bottom:6px;text-transform:uppercase;}
.rtp-slider{
  width:100%;height:6px;-webkit-appearance:none;appearance:none;
  background:linear-gradient(90deg,var(--amber) 0%,var(--amber) var(--val,50%),rgba(255,255,255,.1) var(--val,50%),rgba(255,255,255,.1) 100%);
  border-radius:3px;outline:none;cursor:pointer;
}
.rtp-slider::-webkit-slider-thumb{
  -webkit-appearance:none;width:18px;height:18px;
  background:var(--amber);border-radius:50%;
  box-shadow:0 0 8px var(--amber-glow);cursor:pointer;
  transition:transform .1s;
}
.rtp-slider::-webkit-slider-thumb:hover{transform:scale(1.2);}
.rtp-val-display{
  min-width:54px;text-align:right;
  font-family:'Orbitron',monospace;font-size:14px;font-weight:700;
}
.rtp-val-good{color:var(--green);}
.rtp-val-mid{color:var(--amber);}
.rtp-val-bad{color:var(--red);}
.rtp-mode-tag{font-size:8px;letter-spacing:2px;padding:2px 7px;border-radius:1px;min-width:70px;text-align:center;}
.save-btn{
  padding:10px 24px;background:linear-gradient(135deg,var(--amber),#ffd040);
  color:#000;border:none;font-family:'Orbitron',monospace;font-size:10px;font-weight:700;
  letter-spacing:3px;cursor:pointer;transition:all .2s;text-transform:uppercase;
}
.save-btn:hover{box-shadow:0 0 20px var(--amber-glow);transform:translateY(-1px);}

/* ‚îÄ‚îÄ AI DIFFICULTY ‚îÄ‚îÄ */
.diff-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px;}
.diff-card{
  background:var(--panel);border:2px solid var(--border);padding:20px;
  cursor:pointer;transition:all .2s;text-align:center;position:relative;overflow:hidden;
}
.diff-card::before{content:'';position:absolute;inset:0;opacity:0;transition:opacity .2s;}
.diff-card.d-easy::before{background:linear-gradient(135deg,rgba(0,230,118,.06),transparent);}
.diff-card.d-mid::before{background:linear-gradient(135deg,rgba(255,179,0,.06),transparent);}
.diff-card.d-hard::before{background:linear-gradient(135deg,rgba(255,120,0,.06),transparent);}
.diff-card.d-god::before{background:linear-gradient(135deg,rgba(255,51,51,.06),transparent);}
.diff-card:hover::before,.diff-card.selected::before{opacity:1;}
.diff-card.selected.d-easy{border-color:var(--green);}
.diff-card.selected.d-mid{border-color:var(--amber);}
.diff-card.selected.d-hard{border-color:rgba(255,120,0,.8);}
.diff-card.selected.d-god{border-color:var(--red);}
.diff-icon{font-size:32px;margin-bottom:10px;}
.diff-name{font-family:'Orbitron',monospace;font-size:12px;font-weight:700;letter-spacing:3px;margin-bottom:6px;}
.diff-name.d-easy{color:var(--green);}
.diff-name.d-mid{color:var(--amber);}
.diff-name.d-hard{color:rgba(255,120,0,.9);}
.diff-name.d-god{color:var(--red);}
.diff-desc{font-size:10px;color:var(--text-dim);letter-spacing:1px;line-height:1.7;}
.diff-selected-tag{
  position:absolute;top:10px;right:10px;
  font-size:8px;letter-spacing:2px;padding:2px 6px;
  background:var(--green);color:#000;display:none;
}
.diff-card.selected .diff-selected-tag{display:block;}

.diff-params{background:var(--panel);border:1px solid var(--border);padding:20px;margin-bottom:20px;}
.param-row{display:flex;align-items:center;gap:16px;margin-bottom:14px;flex-wrap:wrap;}
.param-row:last-child{margin-bottom:0;}
.param-label{min-width:200px;font-size:11px;color:var(--text);letter-spacing:1px;}
.param-label small{display:block;font-size:9px;color:var(--text-dim);margin-top:2px;}
.param-slider{flex:1;min-width:150px;height:4px;-webkit-appearance:none;appearance:none;background:rgba(255,255,255,.1);border-radius:2px;outline:none;cursor:pointer;}
.param-slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--amber);border-radius:50%;cursor:pointer;}
.param-val{min-width:40px;text-align:right;font-family:'Orbitron',monospace;font-size:12px;color:var(--amber);}

/* ‚îÄ‚îÄ LOGS ‚îÄ‚îÄ */
.log-toolbar{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center;}
.log-filter{padding:6px 12px;background:transparent;border:1px solid var(--border);color:var(--text-dim);font-family:'Share Tech Mono',monospace;font-size:9px;cursor:pointer;letter-spacing:1px;text-transform:uppercase;transition:all .15s;}
.log-filter.active{border-color:var(--amber);color:var(--amber);background:var(--amber-dim);}
.clear-btn{margin-left:auto;padding:6px 14px;background:transparent;border:1px solid rgba(255,51,51,.3);color:rgba(255,51,51,.6);font-family:'Share Tech Mono',monospace;font-size:9px;cursor:pointer;letter-spacing:1px;text-transform:uppercase;transition:all .15s;}
.clear-btn:hover{border-color:var(--red);color:var(--red);background:var(--red-dim);}

.log-terminal{
  background:#050505;border:1px solid rgba(255,179,0,.1);
  padding:16px;height:420px;overflow-y:auto;
  font-size:11px;line-height:2;
}
.log-terminal::-webkit-scrollbar{width:4px;}
.log-terminal::-webkit-scrollbar-thumb{background:rgba(255,179,0,.2);}
.log-line{display:flex;gap:10px;align-items:flex-start;}
.log-ts{color:rgba(255,179,0,.3);flex-shrink:0;font-size:10px;}
.log-type{font-size:8px;letter-spacing:2px;padding:1px 5px;border-radius:1px;flex-shrink:0;min-width:48px;text-align:center;}
.log-type.GAME{background:rgba(0,180,255,.15);color:var(--blue);}
.log-type.WIN{background:var(--green-dim);color:var(--green);}
.log-type.LOSE{background:var(--red-dim);color:var(--red);}
.log-type.JOIN{background:rgba(198,120,255,.12);color:var(--purple);}
.log-type.SYS{background:var(--amber-dim);color:var(--amber);}
.log-msg{color:var(--text);}

/* ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ */
.settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;}
.setting-group{background:var(--panel);border:1px solid var(--border);padding:20px;}
.setting-title{font-size:9px;letter-spacing:4px;color:var(--amber);text-transform:uppercase;margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid rgba(255,179,0,.08);}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,179,0,.04);}
.setting-row:last-child{border-bottom:none;}
.setting-key{font-size:12px;color:var(--text);}
.setting-key small{display:block;font-size:9px;color:var(--text-dim);margin-top:2px;}
/* Toggle switch */
.toggle{position:relative;width:44px;height:22px;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;}
.toggle-track{position:absolute;inset:0;background:rgba(255,255,255,.1);border-radius:11px;cursor:pointer;transition:.3s;}
.toggle-track::before{content:'';position:absolute;width:16px;height:16px;left:3px;top:3px;background:rgba(255,255,255,.4);border-radius:50%;transition:.3s;}
.toggle input:checked+.toggle-track{background:rgba(255,179,0,.3);border:1px solid var(--amber);}
.toggle input:checked+.toggle-track::before{transform:translateX(22px);background:var(--amber);}
.num-input{background:var(--panel2);border:1px solid var(--border);color:var(--amber);font-family:'Share Tech Mono',monospace;font-size:14px;padding:4px 10px;width:80px;text-align:center;outline:none;}
.num-input:focus{border-color:var(--amber);}

/* Section headers */
.section-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.section-hdr h2{font-family:'Orbitron',monospace;font-size:13px;font-weight:700;color:var(--amber);letter-spacing:4px;text-transform:uppercase;}

/* Modal player detail */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:500;}
.modal-overlay.open{display:flex;}
.modal-box{background:var(--panel);border:1px solid rgba(255,179,0,.3);padding:28px;max-width:480px;width:90%;max-height:85vh;overflow-y:auto;}
.modal-title{font-family:'Orbitron',monospace;font-size:14px;color:var(--amber);letter-spacing:4px;margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid var(--border);}
.modal-close{float:right;background:transparent;border:none;color:var(--text-dim);font-size:18px;cursor:pointer;font-family:'Share Tech Mono',monospace;}
.modal-close:hover{color:var(--red);}
.detail-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(255,179,0,.04);font-size:12px;}
.detail-key{color:var(--text-dim);letter-spacing:1px;}
.detail-val{color:var(--text);}
</style>
</head>
<body>

<!-- Player detail modal -->
<div class="modal-overlay" id="playerModal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div class="modal-title" id="modalTitle">PROFIL JOUEUR</div>
    <div id="modalContent"></div>
  </div>
</div>

<div class="shell">
<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-text">POKO</div>
    <div class="logo-sub">Control Room</div>
  </div>
  <div class="system-status"><div class="status-dot"></div>SYST√àME OP√âRATIONNEL</div>
  <nav class="nav-section">
    <div class="nav-label">Modules</div>
    <div class="nav-item active" onclick="showPanel('dashboard')"><span class="nav-icon">üìä</span>Dashboard</div>
    <div class="nav-item" onclick="showPanel('players')"><span class="nav-icon">üë•</span>Joueurs</div>
    <div class="nav-item" onclick="showPanel('rtp')"><span class="nav-icon">üé∞</span>Contr√¥le RTP</div>
    <div class="nav-item" onclick="showPanel('difficulty')"><span class="nav-icon">ü§ñ</span>Difficult√© IA</div>
    <div class="nav-item" onclick="showPanel('logs')"><span class="nav-icon">üìã</span>Journal</div>
    <div class="nav-item" onclick="showPanel('caisse')"><span class="nav-icon">üíµ</span>Caisse Casino</div>
    <div class="nav-item" onclick="showPanel('subprofiles')"><span class="nav-icon">üîê</span>Sous-profils</div>
    <div class="nav-item" onclick="showPanel('datatransfer')"><span class="nav-icon">üîÑ</span>Transfert donn√©es</div>
    <div class="nav-item" onclick="showPanel('settings')"><span class="nav-icon">‚öôÔ∏è</span>Param√®tres</div>
  </nav>
  <div class="sidebar-footer">
    <div>Admin connect√©</div>
    <div style="color:var(--amber);margin-top:3px;" id="adminTime"></div>
    <button class="logout-btn" onclick="adminLogout()">[ D√âCONNEXION ]</button>
  </div>
</aside>

<!-- MAIN -->
<main class="main">
  <div class="topbar">
    <div class="topbar-title" id="topbarTitle">DASHBOARD</div>
    <div class="topbar-time">POKO CASINO &nbsp;|&nbsp; <span class="topbar-clock" id="clock"></span></div>
  </div>
  <div class="content">

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel active" id="panel-dashboard">
      <div class="kpi-row" id="kpiRow"></div>
      <div class="grid2">
        <div class="card">
          <div class="card-title">Activit√© r√©cente <span id="feedCount">‚Äî</span></div>
          <div class="feed" id="activityFeed"></div>
        </div>
        <div class="card">
          <div class="card-title">Parties par joueur <span>7 derniers jours</span></div>
          <div class="bar-chart" id="barChart"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Top joueurs par gains <span>Classement global</span></div>
        <table class="players-table" id="dashTopTable"></table>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PLAYERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-players">
      <div class="section-hdr"><h2>Gestion des Joueurs</h2></div>
      <div class="players-toolbar">
        <input class="search-input" type="text" id="playerSearch" placeholder="Rechercher un joueur..." oninput="renderPlayers()">
        <button class="filter-btn active" id="fAll" onclick="setFilter('all')">Tous</button>
        <button class="filter-btn" id="fActive" onclick="setFilter('active')">Actifs</button>
        <button class="filter-btn" id="fBanned" onclick="setFilter('banned')">Bannis</button>
      </div>
      <div class="card" style="padding:0;overflow:hidden;">
        <table class="players-table" id="playersTable">
          <thead><tr>
            <th>Avatar</th><th>Pseudo</th><th>Solde</th><th>Parties</th><th>Victoires</th><th>Statut</th><th>Actions</th>
          </tr></thead>
          <tbody id="playersTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RTP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-rtp">
      <div class="section-hdr"><h2>Contr√¥le RTP ‚Äî Distribution des Cartes</h2></div>
      <div class="rtp-header">
        <span style="font-size:20px;">‚ö†Ô∏è</span>
        <div class="rtp-warning">
          <strong>CONTR√îLE AVANC√â :</strong> Ces param√®tres modifient la distribution des cartes en temps r√©el.<br>
          50% = distribution √©quitable ¬∑ &gt;50% = avantage joueur ¬∑ &lt;50% = d√©savantage joueur
        </div>
      </div>

      <!-- Global presets -->
      <div class="rtp-global">
        <div class="rtp-global-title">
          Pr√©r√©glages globaux ‚Äî tous les joueurs humains
          <span style="font-size:9px;color:var(--text-dim);">APPLIQU√â SUR TOUS</span>
        </div>
        <div class="rtp-preset-row">
          <button class="rtp-preset p-neutre" onclick="applyGlobalPreset('neutre',50)">‚öñÔ∏è NEUTRE (50%)</button>
          <button class="rtp-preset p-fav" onclick="applyGlobalPreset('fav',70)">üçÄ FAVORIS√â (70%)</button>
          <button class="rtp-preset p-defav" onclick="applyGlobalPreset('defav',35)">üìâ D√âFAVORIS√â (35%)</button>
          <button class="rtp-preset p-ruine" onclick="applyGlobalPreset('ruine',15)">üíÄ RUIN√â (15%)</button>
        </div>
      </div>

      <!-- Individual players -->
      <div class="card-title" style="margin-bottom:14px;">Contr√¥le individuel par joueur</div>
      <div class="rtp-players" id="rtpPlayers"></div>
      <div style="margin-top:20px;display:flex;gap:12px;align-items:center;">
        <button class="save-btn" onclick="saveRTP()">ENREGISTRER LES PARAM√àTRES RTP</button>
        <span id="rtpSaveMsg" style="font-size:10px;color:var(--green);display:none;">‚úì Param√®tres sauvegard√©s</span>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DIFFICULTY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-difficulty">
      <div class="section-hdr"><h2>Difficult√© de l'IA</h2></div>
      <div class="diff-grid">
        <div class="diff-card d-easy selected" onclick="selectDiff('easy')">
          <div class="diff-selected-tag">ACTIF</div>
          <div class="diff-icon">üê£</div>
          <div class="diff-name d-easy">D√âBUTANT</div>
          <div class="diff-desc">L'IA joue al√©atoirement.<br>Aucune strat√©gie. Erreurs fr√©quentes.</div>
        </div>
        <div class="diff-card d-mid" onclick="selectDiff('mid')">
          <div class="diff-selected-tag">ACTIF</div>
          <div class="diff-icon">ü¶ä</div>
          <div class="diff-name d-mid">NORMAL</div>
          <div class="diff-desc">L'IA joue correctement.<br>Strat√©gie basique. Quelques erreurs.</div>
        </div>
        <div class="diff-card d-hard" onclick="selectDiff('hard')">
          <div class="diff-selected-tag">ACTIF</div>
          <div class="diff-icon">üê∫</div>
          <div class="diff-name d-hard">EXPERT</div>
          <div class="diff-desc">L'IA m√©morise les cartes jou√©es.<br>Strat√©gie optimale. Tr√®s agressif.</div>
        </div>
        <div class="diff-card d-god" onclick="selectDiff('god')">
          <div class="diff-selected-tag">ACTIF</div>
          <div class="diff-icon">üëÅÔ∏è</div>
          <div class="diff-name d-god">DIVIN</div>
          <div class="diff-desc">L'IA conna√Æt toutes les cartes.<br>Imbattable. Joue toujours parfaitement.</div>
        </div>
      </div>

      <div class="diff-params card">
        <div class="card-title">Param√®tres fins de l'IA <span id="diffParamsLabel">D√âBUTANT</span></div>
        <div class="param-row">
          <div class="param-label">Fr√©quence de CASS√â optimal<small>Probabilit√© que l'IA casse quand elle peut</small></div>
          <input class="param-slider" type="range" id="pCasse" min="0" max="100" value="30" oninput="updateParam(this,'pCasseVal')">
          <div class="param-val" id="pCasseVal">30%</div>
        </div>
        <div class="param-row">
          <div class="param-label">M√©moire des cartes jou√©es<small>% de cartes dont l'IA se souvient</small></div>
          <input class="param-slider" type="range" id="pMemory" min="0" max="100" value="20" oninput="updateParam(this,'pMemoryVal')">
          <div class="param-val" id="pMemoryVal">20%</div>
        </div>
        <div class="param-row">
          <div class="param-label">Agressivit√© (casser t√¥t)<small>Tendance √† jouer haut d√®s le d√©but</small></div>
          <input class="param-slider" type="range" id="pAggro" min="0" max="100" value="20" oninput="updateParam(this,'pAggroVal')">
          <div class="param-val" id="pAggroVal">20%</div>
        </div>
        <div class="param-row">
          <div class="param-label">D√©lai de r√©ponse simul√©<small>Temps de "r√©flexion" de l'IA (ms)</small></div>
          <input class="param-slider" type="range" id="pDelay" min="300" max="3000" value="1200" oninput="updateParam(this,'pDelayVal','ms')">
          <div class="param-val" id="pDelayVal">1200ms</div>
        </div>
        <div style="margin-top:16px;">
          <button class="save-btn" onclick="saveDifficulty()">APPLIQUER LA DIFFICULT√â</button>
          <span id="diffSaveMsg" style="font-size:10px;color:var(--green);margin-left:14px;display:none;">‚úì Difficult√© sauvegard√©e</span>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-logs">
      <div class="section-hdr"><h2>Journal des Parties</h2></div>
      <div class="log-toolbar">
        <button class="log-filter active" onclick="filterLog('all',this)">TOUT</button>
        <button class="log-filter" onclick="filterLog('GAME',this)">PARTIES</button>
        <button class="log-filter" onclick="filterLog('WIN',this)">VICTOIRES</button>
        <button class="log-filter" onclick="filterLog('LOSE',this)">D√âFAITES</button>
        <button class="log-filter" onclick="filterLog('SYS',this)">SYST√àME</button>
        <button class="clear-btn" onclick="clearLogs()">EFFACER</button>
      </div>
      <div class="log-terminal" id="logTerminal"></div>
    </div>



    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TRANSFERT DONN√âES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-datatransfer">
      <div class="section-hdr">
        <h2>üîÑ Transfert de donn√©es</h2>
        <div style="font-size:10px;color:var(--text-dim);letter-spacing:2px;">LOCAL ‚Üî EN LIGNE</div>
      </div>

      <div style="background:var(--amber-dim);border:1px solid rgba(230,57,70,.25);padding:14px 18px;margin-bottom:22px;font-size:11px;color:var(--text);letter-spacing:1px;line-height:2;">
        üí° <strong style="color:var(--amber)">Pourquoi ?</strong> Chaque navigateur/appareil a son propre localStorage.<br>
        Utilise cet outil pour <strong>exporter</strong> tes donn√©es locales en fichier JSON, puis les <strong>importer</strong> sur n'importe quel autre appareil ou d√©ploiement (GitHub Pages, etc.)
      </div>

      <div class="grid2" style="margin-bottom:24px;">

        <!-- EXPORT -->
        <div class="card">
          <div class="card-title">üì§ Exporter les donn√©es</div>
          <div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;margin-bottom:16px;line-height:1.9;">
            T√©l√©charge un fichier <code style="color:var(--amber);background:rgba(230,57,70,.1);padding:1px 5px;">poko_data.json</code> contenant tous les comptes joueurs, param√®tres RTP, difficult√© et r√©glages admin.
          </div>
          <div id="exportSummary" style="margin-bottom:16px;padding:12px;background:rgba(0,0,0,.3);border:1px solid var(--border);font-size:11px;line-height:2;"></div>
          <button class="save-btn" onclick="exportData()" style="width:100%;">‚¨áÔ∏è T√âL√âCHARGER poko_data.json</button>
        </div>

        <!-- IMPORT -->
        <div class="card">
          <div class="card-title">üì• Importer des donn√©es</div>
          <div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;margin-bottom:16px;line-height:1.9;">
            Charge un fichier <code style="color:var(--amber);background:rgba(230,57,70,.1);padding:1px 5px;">poko_data.json</code> export√© depuis un autre appareil. <strong style="color:var(--red)">Les donn√©es actuelles seront remplac√©es.</strong>
          </div>
          <div style="margin-bottom:14px;">
            <input type="file" id="importFile" accept=".json" onchange="previewImport(this)"
              style="width:100%;padding:10px;background:rgba(230,57,70,.05);border:1px dashed rgba(230,57,70,.3);color:var(--text);font-family:'Share Tech Mono',monospace;font-size:11px;cursor:pointer;">
          </div>
          <div id="importPreview" style="display:none;margin-bottom:14px;padding:12px;background:rgba(0,0,0,.3);border:1px solid var(--border);font-size:11px;line-height:2;"></div>
          <button class="save-btn" id="importBtn" onclick="importData()" style="width:100%;display:none;">‚¨ÜÔ∏è IMPORTER ET REMPLACER</button>
          <div id="importMsg" style="font-size:11px;margin-top:10px;display:none;"></div>
        </div>
      </div>

      <!-- DEMO DATA -->
      <div class="card">
        <div class="card-title">üé≠ Donn√©es de d√©monstration <span>D√âMARRAGE RAPIDE</span></div>
        <div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;margin-bottom:16px;line-height:1.9;">
          Injecte des joueurs fictifs avec historique de parties pour tester l'interface admin sans avoir de vrais joueurs. Utile pour une d√©mo en ligne.
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <button class="save-btn" onclick="injectDemoData()">üéÆ INJECTER LES DONN√âES DE D√âMO</button>
          <button class="action-btn ban" onclick="clearAllData()" style="padding:10px 16px;">üóëÔ∏è TOUT EFFACER</button>
          <div id="demoMsg" style="font-size:11px;display:none;"></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SOUS-PROFILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-subprofiles">
      <div class="section-hdr">
        <h2>üîê Sous-profils Administrateurs</h2>
        <div style="font-size:10px;color:var(--text-dim);letter-spacing:2px;">ACC√àS RESTREINTS</div>
      </div>

      <div style="background:var(--amber-dim);border:1px solid rgba(230,57,70,.25);padding:14px 18px;margin-bottom:22px;font-size:11px;color:var(--text);letter-spacing:1px;line-height:1.8;">
        ‚öôÔ∏è Cr√©ez des sous-comptes admin avec des acc√®s limit√©s √† certains modules.<br>
        Utile pour d√©l√©guer la gestion des joueurs ou du reporting sans donner acc√®s au RTP ou aux param√®tres sensibles.
      </div>

      <!-- Cr√©er un sous-profil -->
      <div class="grid2" style="margin-bottom:24px;">
        <div class="card">
          <div class="card-title">‚ûï Cr√©er un sous-profil</div>
          <div class="field" style="margin-bottom:14px;">
            <div style="font-size:9px;letter-spacing:3px;color:var(--amber);text-transform:uppercase;margin-bottom:7px;">Identifiant</div>
            <input type="text" id="sp-user" placeholder="ex: superviseur1" style="width:100%;padding:10px 14px;background:rgba(230,57,70,.05);border:1px solid var(--border);color:var(--text);font-family:'Share Tech Mono',monospace;font-size:13px;outline:none;">
          </div>
          <div class="field" style="margin-bottom:14px;">
            <div style="font-size:9px;letter-spacing:3px;color:var(--amber);text-transform:uppercase;margin-bottom:7px;">Mot de passe</div>
            <input type="password" id="sp-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;padding:10px 14px;background:rgba(230,57,70,.05);border:1px solid var(--border);color:var(--text);font-family:'Share Tech Mono',monospace;font-size:13px;outline:none;">
          </div>
          <div class="field" style="margin-bottom:16px;">
            <div style="font-size:9px;letter-spacing:3px;color:var(--amber);text-transform:uppercase;margin-bottom:10px;">Acc√®s autoris√©s</div>
            <div id="sp-perms" style="display:flex;flex-direction:column;gap:6px;">
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:12px;color:var(--text);">
                <label class="toggle"><input type="checkbox" name="perm" value="dashboard" checked><span class="toggle-track"></span></label>
                üìä Dashboard
              </label>
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:12px;color:var(--text);">
                <label class="toggle"><input type="checkbox" name="perm" value="players"><span class="toggle-track"></span></label>
                üë• Gestion Joueurs
              </label>
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:12px;color:var(--text);">
                <label class="toggle"><input type="checkbox" name="perm" value="rtp"><span class="toggle-track"></span></label>
                üé∞ Contr√¥le RTP
              </label>
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:12px;color:var(--text);">
                <label class="toggle"><input type="checkbox" name="perm" value="difficulty"><span class="toggle-track"></span></label>
                ü§ñ Difficult√© IA
              </label>
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:12px;color:var(--text);">
                <label class="toggle"><input type="checkbox" name="perm" value="logs"><span class="toggle-track"></span></label>
                üìã Journal
              </label>
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:12px;color:var(--text);">
                <label class="toggle"><input type="checkbox" name="perm" value="caisse"><span class="toggle-track"></span></label>
                üíµ Caisse Casino
              </label>
              <label style="display:flex;align-items:center;gap:10px;cursor:pointer;font-size:12px;color:var(--text);">
                <label class="toggle"><input type="checkbox" name="perm" value="settings"><span class="toggle-track"></span></label>
                ‚öôÔ∏è Param√®tres
              </label>
            </div>
          </div>
          <button class="save-btn" onclick="createSubProfile()" style="width:100%;">CR√âER LE SOUS-PROFIL</button>
          <div id="sp-msg" style="font-size:11px;margin-top:10px;display:none;"></div>
        </div>

        <!-- Liste sous-profils -->
        <div class="card">
          <div class="card-title">üë• Sous-profils existants <span id="sp-count">‚Äî</span></div>
          <div id="sp-list" style="display:flex;flex-direction:column;gap:10px;"></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-settings">
      <div class="section-hdr"><h2>Param√®tres Globaux</h2></div>
      <div class="settings-grid">
        <div class="setting-group">
          <div class="setting-title">Jeu ‚Äî R√®gles</div>
          <div class="setting-row">
            <div class="setting-key">Mise minimale (FCFA)<small>Minimum requis pour jouer</small></div>
            <input class="num-input" type="number" id="cfg-minBet" value="50">
          </div>
          <div class="setting-row">
            <div class="setting-key">Mise maximale (FCFA)<small>Plafond par partie</small></div>
            <input class="num-input" type="number" id="cfg-maxBet" value="10000">
          </div>
          <div class="setting-row">
            <div class="setting-key">Bonus de bienvenue (FCFA)<small>Offert √† l'inscription</small></div>
            <input class="num-input" type="number" id="cfg-welcomeBonus" value="5000">
          </div>
          <div class="setting-row">
            <div class="setting-key">Bonus quotidien (FCFA)<small>R√©clam√© une fois par jour</small></div>
            <input class="num-input" type="number" id="cfg-dailyBonus" value="500">
          </div>
        </div>
        <div class="setting-group">
          <div class="setting-title">Jeu ‚Äî Fonctionnalit√©s</div>
          <div class="setting-row">
            <div class="setting-key">Inscriptions ouvertes<small>Autoriser les nouveaux comptes</small></div>
            <label class="toggle"><input type="checkbox" id="cfg-register" checked><span class="toggle-track"></span></label>
          </div>
          <div class="setting-row">
            <div class="setting-key">KIN activ√© par d√©faut<small>Option pr√©-coch√©e dans le menu</small></div>
            <label class="toggle"><input type="checkbox" id="cfg-kin" checked><span class="toggle-track"></span></label>
          </div>
          <div class="setting-row">
            <div class="setting-key">Journal de partie visible<small>Montrer le log au joueur</small></div>
            <label class="toggle"><input type="checkbox" id="cfg-showLog" checked><span class="toggle-track"></span></label>
          </div>
          <div class="setting-row">
            <div class="setting-key">Animations activ√©es<small>Cartes volantes, effets visuels</small></div>
            <label class="toggle"><input type="checkbox" id="cfg-anims" checked><span class="toggle-track"></span></label>
          </div>
        </div>
        <div class="setting-group">
          <div class="setting-title">S√©curit√© Admin</div>
          <div class="setting-row">
            <div class="setting-key">Nouveau mot de passe admin<small>Laissez vide pour ne pas changer</small></div>
            <input class="num-input" type="password" id="cfg-newpass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:120px;">
          </div>
          <div style="margin-top:16px;">
            <button class="save-btn" onclick="saveSettings()">ENREGISTRER TOUT</button>
            <span id="settingsSaveMsg" style="font-size:10px;color:var(--green);margin-left:14px;display:none;">‚úì Sauvegard√©</span>
          </div>
        </div>
      </div>
    </div>


    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CAISSE CASINO ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
    <div class="panel" id="panel-caisse">
      <div class="section-hdr">
        <h2>üíµ Caisse du Casino</h2>
        <div style="font-size:10px;color:var(--text-dim);letter-spacing:2px;">VOTRE P&L EN TEMPS R√âEL</div>
      </div>

      <!-- Solde casino hero -->
      <div id="caisseSoldeHero" style="
        background:linear-gradient(135deg,rgba(255,179,0,.08) 0%,rgba(0,0,0,.4) 100%);
        border:1px solid rgba(255,179,0,.3);padding:28px 32px;margin-bottom:24px;
        display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:20px;
      ">
        <div>
          <div style="font-size:9px;letter-spacing:4px;color:var(--text-dim);text-transform:uppercase;margin-bottom:8px;">Solde Casino</div>
          <div id="caisseSoldeVal" style="font-family:'Orbitron',monospace;font-size:42px;font-weight:900;color:var(--amber);text-shadow:0 0 20px var(--amber-glow);letter-spacing:3px;">‚Äî</div>
          <div style="font-size:10px;color:var(--text-dim);margin-top:6px;letter-spacing:2px;">FCFA VIRTUELS</div>
        </div>
        <div style="display:flex;gap:16px;flex-wrap:wrap;">
          <div style="text-align:center;">
            <div style="font-size:8px;letter-spacing:3px;color:var(--green);text-transform:uppercase;margin-bottom:6px;">Encaiss√©</div>
            <div id="caisseEncaisse" style="font-family:'Orbitron',monospace;font-size:20px;color:var(--green);">‚Äî</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:8px;letter-spacing:3px;color:var(--red);text-transform:uppercase;margin-bottom:6px;">D√©caiss√©</div>
            <div id="caisseDecaisse" style="font-family:'Orbitron',monospace;font-size:20px;color:var(--red);">‚Äî</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:8px;letter-spacing:3px;color:var(--blue);text-transform:uppercase;margin-bottom:6px;">Monnaie √©mise</div>
            <div id="caisseEmise" style="font-family:'Orbitron',monospace;font-size:20px;color:var(--blue);">‚Äî</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:8px;letter-spacing:3px;color:var(--purple);text-transform:uppercase;margin-bottom:6px;">Marge nette</div>
            <div id="caisseMarge" style="font-family:'Orbitron',monospace;font-size:20px;color:var(--purple);">‚Äî</div>
          </div>
        </div>
      </div>

      <!-- KPI Row -->
      <div class="kpi-row" id="caisseKpi"></div>

      <div class="grid2" style="margin-bottom:24px;">
        <!-- √âmission de monnaie virtuelle -->
        <div class="card">
          <div class="card-title">üè¶ √âmission de monnaie virtuelle <span>BANQUE CENTRALE</span></div>
          <div style="font-size:11px;color:var(--text-dim);letter-spacing:1px;margin-bottom:16px;line-height:1.8;">
            Injectez de la monnaie dans l'√©conomie du jeu.<br>
            Ces FCFA virtuels s'ajoutent au solde des joueurs s√©lectionn√©s.
          </div>

          <!-- Montant -->
          <div style="margin-bottom:14px;">
            <div style="font-size:9px;letter-spacing:3px;color:var(--amber);text-transform:uppercase;margin-bottom:8px;">Montant √† √©mettre</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
              <button class="action-btn view" onclick="setEmit(500)">500</button>
              <button class="action-btn view" onclick="setEmit(1000)">1 000</button>
              <button class="action-btn view" onclick="setEmit(5000)">5 000</button>
              <button class="action-btn view" onclick="setEmit(10000)">10 000</button>
              <button class="action-btn view" onclick="setEmit(50000)">50 000</button>
            </div>
            <input type="number" id="emitAmount" placeholder="Montant FCFA" style="width:100%;padding:10px 14px;background:rgba(255,179,0,.05);border:1px solid var(--border);color:var(--amber);font-family:'Share Tech Mono',monospace;font-size:16px;outline:none;" value="1000">
          </div>

          <!-- Cible -->
          <div style="margin-bottom:14px;">
            <div style="font-size:9px;letter-spacing:3px;color:var(--amber);text-transform:uppercase;margin-bottom:8px;">Destinataire</div>
            <select id="emitTarget" style="width:100%;padding:10px 14px;background:var(--panel2);border:1px solid var(--border);color:var(--text);font-family:'Share Tech Mono',monospace;font-size:13px;outline:none;cursor:pointer;">
              <option value="all">Tous les joueurs actifs</option>
            </select>
          </div>

          <div style="font-size:10px;color:rgba(255,150,50,.7);margin-bottom:14px;letter-spacing:1px;padding:8px 12px;background:rgba(255,150,50,.06);border-left:2px solid rgba(255,150,50,.4);">
            ‚ö†Ô∏è Ces fonds sont √©mis hors mise ‚Äî ils n'impactent pas votre caisse directement mais augmentent la liquidit√© des joueurs.
          </div>

          <button class="save-btn" onclick="emitMoney()" style="width:100%;">√âMETTRE LA MONNAIE</button>
          <div id="emitMsg" style="font-size:11px;margin-top:10px;display:none;"></div>
        </div>

        <!-- Flux de tr√©sorerie -->
        <div class="card">
          <div class="card-title">üìà Cash Flow ‚Äî Flux de tr√©sorerie <span id="cfPeriod">TOUT</span></div>
          <div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap;">
            <button class="log-filter active" id="cf7" onclick="setCFPeriod(7,this)">7J</button>
            <button class="log-filter" id="cf30" onclick="setCFPeriod(30,this)">30J</button>
            <button class="log-filter" id="cfAll" onclick="setCFPeriod(0,this)">TOUT</button>
          </div>
          <div id="cashFlowList" style="max-height:260px;overflow-y:auto;"></div>
        </div>
      </div>

      <!-- D√©tail P&L par joueur -->
      <div class="card">
        <div class="card-title">üéØ P&L par joueur ‚Äî Rentabilit√© individuelle <span>Qui vous rapporte le plus</span></div>
        <table class="players-table" id="pnlTable">
          <thead><tr>
            <th>Joueur</th>
            <th>D√©p√¥ts (entr√©)</th>
            <th>Gains vers√©s (sorti)</th>
            <th>Pertes encaiss√©es</th>
            <th>Bonus √©mis</th>
            <th>P&L Net</th>
            <th>Statut</th>
          </tr></thead>
          <tbody id="pnlTbody"></tbody>
        </table>
      </div>

      <!-- Historique des transactions casino -->
      <div class="card" style="margin-top:20px;">
        <div class="card-title">üßæ Grand livre ‚Äî Toutes les transactions <span id="ledgerCount"></span></div>
        <div id="ledgerList" style="max-height:320px;overflow-y:auto;font-size:11px;"></div>
      </div>
    </div>

  </div><!-- /content -->
</main>
</div><!-- /shell -->

<script>
// ‚îÄ‚îÄ GUARD ‚îÄ‚îÄ
if(!sessionStorage.getItem('poko_admin')){ window.location.href='admin-login.html'; }

// ‚îÄ‚îÄ Supabase client (m√™me config que auth.js) ‚îÄ‚îÄ
const SUPABASE_URL_ADMIN = 'https://agghgyidejzlxidrjswv.supabase.co';
const SUPABASE_KEY_ADMIN = 'sb_publishable_5E4A6-zcPdhqZ9JC87ZK4Q_j75J3m6W';
const SB = {
  headers: { 'Content-Type':'application/json','apikey':SUPABASE_KEY_ADMIN,'Authorization':'Bearer '+SUPABASE_KEY_ADMIN,'Prefer':'return=representation' },
  async get(table,filters){ try{ const r=await fetch(`${SUPABASE_URL_ADMIN}/rest/v1/${table}?${filters||''}`,{headers:this.headers}); return r.ok?r.json():[];}catch(e){return[];} },
  async update(table,data,filters){ try{ const r=await fetch(`${SUPABASE_URL_ADMIN}/rest/v1/${table}?${filters}`,{method:'PATCH',headers:{...this.headers,'Prefer':'return=minimal'},body:JSON.stringify(data)}); return r.ok;}catch(e){return false;} },
  async insert(table,data){ try{ const r=await fetch(`${SUPABASE_URL_ADMIN}/rest/v1/${table}`,{method:'POST',headers:this.headers,body:JSON.stringify(data)}); return r.ok?r.json():null;}catch(e){return null;} },
  async delete(table,filters){ try{ const r=await fetch(`${SUPABASE_URL_ADMIN}/rest/v1/${table}?${filters}`,{method:'DELETE',headers:this.headers}); return r.ok;}catch(e){return false;} }
};

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ
function updateClock(){
  const n=new Date();
  document.getElementById('clock').textContent=n.toLocaleTimeString('fr-FR');
  document.getElementById('adminTime').textContent=n.toLocaleDateString('fr-FR',{weekday:'short',day:'2-digit',month:'short'});
}
setInterval(updateClock,1000); updateClock();

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
const PANEL_TITLES={dashboard:'DASHBOARD',players:'GESTION DES JOUEURS',rtp:'CONTR√îLE RTP',difficulty:'DIFFICULT√â IA',logs:'JOURNAL DES PARTIES',caisse:'üíµ CAISSE DU CASINO',settings:'PARAM√àTRES'};
function showPanel(name){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  event.currentTarget.classList.add('active');
  document.getElementById('topbarTitle').textContent = PANEL_TITLES[name]||name.toUpperCase();
  if(name==='dashboard') renderDashboard().catch(()=>{});
  if(name==='players') renderPlayers().catch(()=>{});
  if(name==='rtp') renderRTP().catch(()=>{});
  if(name==='logs') renderLogs().catch(()=>{});
  if(name==='caisse') renderCaisse().catch(()=>{});
  if(name==='subprofiles') renderSubProfiles();
  if(name==='datatransfer') renderDataTransfer();
}

// ‚îÄ‚îÄ DATA ‚îÄ‚îÄ
function getUsers(){
  // Sync fallback (localStorage) pour compatibilit√© interne
  try{return Object.values(JSON.parse(localStorage.getItem('poko_users')||'{}'));}catch(e){return [];}
}
async function getUsersAsync(){
  // Lecture Supabase en temps r√©el
  try{
    const r=await SB.get('poko_users','select=*&order=created_at.desc');
    if(r&&r.length){
      // Mettre √† jour le cache local
      const obj={};
      r.forEach(row=>{
        const u={
          username:row.username,email:row.email,avatar:row.avatar||'üÉè',
          password:row.password_hash,balance:row.balance||0,
          totalGames:row.total_games||0,totalWins:row.total_wins||0,
          totalEarned:row.total_earned||0,totalLost:row.total_lost||0,
          longestWinStreak:row.longest_streak||0,currentStreak:row.current_streak||0,
          lastDailyBonus:row.last_daily_bonus,banned:row.banned||false,vip:row.vip||false,
          createdAt:row.created_at,lastLogin:row.last_login,transactions:[],history:[]
        };
        obj[u.username]=u;
      });
      localStorage.setItem('poko_users',JSON.stringify(obj));
      return Object.values(obj);
    }
  }catch(e){}
  return getUsers();
}
function getAdminSettings(){ try{return JSON.parse(localStorage.getItem('poko_admin_settings')||'{}');}catch(e){return {};} }
function saveAdminSettings(s){ localStorage.setItem('poko_admin_settings',JSON.stringify(s)); }
function getAdminLogs(){ try{return JSON.parse(localStorage.getItem('poko_admin_logs')||'[]');}catch(e){return [];} }
function addAdminLog(type,msg){
  const l=getAdminLogs(); l.unshift({ts:Date.now(),type,msg}); if(l.length>200)l.splice(200); localStorage.setItem('poko_admin_logs',JSON.stringify(l));
  const ts=Date.now();
  SB.insert('poko_admin_logs',{id:ts,ts,type,msg}).catch(()=>{});
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ
async function renderDashboard(){
  const users=await getUsersAsync();
  const total=users.reduce((a,u)=>(a+u.totalGames||0),0);
  const totalWins=users.reduce((a,u)=>(a+u.totalWins||0),0);
  const totalBalance=users.reduce((a,u)=>(a+u.balance||0),0);
  const active=users.filter(u=>!u.banned).length;

  document.getElementById('kpiRow').innerHTML=`
    <div class="kpi"><div class="kpi-label">Joueurs enregistr√©s</div><div class="kpi-val">${users.length}</div><div class="kpi-sub">${active} actifs</div></div>
    <div class="kpi green"><div class="kpi-label">Total parties jou√©es</div><div class="kpi-val">${total}</div><div class="kpi-sub">${totalWins} victoires</div></div>
    <div class="kpi blue"><div class="kpi-label">Solde total en jeu</div><div class="kpi-val">${totalBalance.toLocaleString('fr-FR')}</div><div class="kpi-sub">FCFA cumul√©s</div></div>
    <div class="kpi red"><div class="kpi-label">Taux de victoire moyen</div><div class="kpi-val">${total>0?Math.round(totalWins/total*100):0}%</div><div class="kpi-sub">Global</div></div>
  `;

  // Activity feed from transactions
  const feed=document.getElementById('activityFeed');
  const allTx=[];
  users.forEach(u=>(u.transactions||[]).forEach(tx=>allTx.push({...tx,username:u.username})));
  allTx.sort((a,b)=>b.date-a.date);
  document.getElementById('feedCount').textContent=allTx.length+' √©v√©nements';
  feed.innerHTML=allTx.slice(0,20).map(tx=>{
    const dots={win:'win',loss:'lose',deposit:'join',bonus:'warn',withdraw:'warn'};
    return `<div class="feed-item">
      <div class="feed-time">${new Date(tx.date).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}</div>
      <div class="feed-dot ${dots[tx.type]||'join'}"></div>
      <div class="feed-text">${tx.username} ‚Äî ${tx.label}</div>
    </div>`;
  }).join('') || '<div style="color:var(--text-dim);font-size:11px;padding:10px 0;">Aucune activit√©</div>';

  // Bar chart: top 6 users by games
  const top=users.sort((a,b)=>(b.totalGames||0)-(a.totalGames||0)).slice(0,6);
  const max=Math.max(...top.map(u=>u.totalGames||1),1);
  document.getElementById('barChart').innerHTML=top.map(u=>`
    <div class="bar-col">
      <div class="bar-val">${u.totalGames||0}</div>
      <div class="bar" style="height:${Math.round(((u.totalGames||0)/max)*80)+4}px"></div>
      <div class="bar-lbl">${u.username.slice(0,6)}</div>
    </div>
  `).join('');

  // Top table
  const sorted=users.sort((a,b)=>(b.totalEarned||0)-(a.totalEarned||0)).slice(0,8);
  document.getElementById('dashTopTable').innerHTML=`
    <thead><tr><th>#</th><th>Joueur</th><th>Parties</th><th>Victoires</th><th>Gains totaux</th><th>Solde</th></tr></thead>
    <tbody>${sorted.map((u,i)=>`<tr>
      <td style="color:var(--amber);font-family:Orbitron,monospace;">${i+1}</td>
      <td>${u.avatar||'üÉè'} ${u.username}</td>
      <td>${u.totalGames||0}</td>
      <td style="color:var(--green)">${u.totalWins||0}</td>
      <td style="color:var(--green)">+${(u.totalEarned||0).toLocaleString('fr-FR')} FCFA</td>
      <td style="color:var(--amber)">${(u.balance||0).toLocaleString('fr-FR')} FCFA</td>
    </tr>`).join('')}</tbody>
  `;
}

// ‚îÄ‚îÄ PLAYERS ‚îÄ‚îÄ
let playerFilter='all';
function setFilter(f){ playerFilter=f; ['fAll','fActive','fBanned'].forEach(id=>document.getElementById(id).classList.remove('active')); document.getElementById('f'+f.charAt(0).toUpperCase()+f.slice(1)).classList.add('active'); renderPlayers(); }
async function renderPlayers(){
  const q=(document.getElementById('playerSearch')?.value||'').toLowerCase();
  let users=await getUsersAsync().filter(u=>u.username!=='admin');
  if(q) users=users.filter(u=>u.username.toLowerCase().includes(q));
  if(playerFilter==='active') users=users.filter(u=>!u.banned);
  if(playerFilter==='banned') users=users.filter(u=>u.banned);
  const tbody=document.getElementById('playersTbody');
  if(!tbody) return;
  tbody.innerHTML=users.map(u=>`<tr>
    <td style="font-size:20px;">${u.avatar||'üÉè'}</td>
    <td><strong style="color:var(--text)">${u.username}</strong><br><small style="color:var(--text-dim)">${u.email||'‚Äî'}</small></td>
    <td style="color:var(--amber)">${(u.balance||0).toLocaleString('fr-FR')} FCFA</td>
    <td>${u.totalGames||0}</td>
    <td style="color:var(--green)">${u.totalWins||0}</td>
    <td>${u.banned
      ? '<span class="status-badge banned">BANNI</span>'
      : u.vip ? '<span class="status-badge vip">VIP</span>' : '<span class="status-badge active">ACTIF</span>'}</td>
    <td>
      <button class="action-btn view" onclick="viewPlayer('${u.username}')">VOIR</button>
      ${u.banned
        ? `<button class="action-btn unban" onclick="toggleBan('${u.username}',false)">D√âBANNIR</button>`
        : `<button class="action-btn ban" onclick="toggleBan('${u.username}',true)">BANNIR</button>`}
      <button class="action-btn vip" onclick="toggleVIP('${u.username}')">VIP</button>
    </td>
  </tr>`).join('') || '<tr><td colspan="7" style="text-align:center;color:var(--text-dim);padding:30px;">Aucun joueur trouv√©</td></tr>';
}

async function toggleBan(username,ban){
  await SB.update('poko_users',{banned:ban},`username=eq.${encodeURIComponent(username)}`);
  const users=JSON.parse(localStorage.getItem('poko_users')||'{}');
  if(users[username]){ users[username].banned=ban; localStorage.setItem('poko_users',JSON.stringify(users)); }
  addAdminLog('SYS',`${ban?'Bannissement':'D√©bannissement'} de ${username}`);
  renderPlayers();
}
async function toggleVIP(username){
  const users=JSON.parse(localStorage.getItem('poko_users')||'{}');
  const newVip=!(users[username]?.vip||false);
  await SB.update('poko_users',{vip:newVip},`username=eq.${encodeURIComponent(username)}`);
  if(users[username]){ users[username].vip=newVip; localStorage.setItem('poko_users',JSON.stringify(users)); }
  addAdminLog('SYS',`VIP toggl√© pour ${username}`);
  renderPlayers();
}
function viewPlayer(username){
  const users=JSON.parse(localStorage.getItem('poko_users')||'{}');
  const u=users[username]; if(!u) return;
  document.getElementById('modalTitle').textContent=`${u.avatar||'üÉè'} ${u.username.toUpperCase()}`;
  const wr=u.totalGames>0?Math.round(u.totalWins/u.totalGames*100):0;
  document.getElementById('modalContent').innerHTML=`
    <div class="detail-row"><span class="detail-key">Email</span><span class="detail-val">${u.email||'‚Äî'}</span></div>
    <div class="detail-row"><span class="detail-key">Solde</span><span class="detail-val" style="color:var(--amber)">${(u.balance||0).toLocaleString('fr-FR')} FCFA</span></div>
    <div class="detail-row"><span class="detail-key">Parties jou√©es</span><span class="detail-val">${u.totalGames||0}</span></div>
    <div class="detail-row"><span class="detail-key">Victoires</span><span class="detail-val" style="color:var(--green)">${u.totalWins||0}</span></div>
    <div class="detail-row"><span class="detail-key">Taux de victoire</span><span class="detail-val">${wr}%</span></div>
    <div class="detail-row"><span class="detail-key">Total gagn√©</span><span class="detail-val" style="color:var(--green)">+${(u.totalEarned||0).toLocaleString('fr-FR')} FCFA</span></div>
    <div class="detail-row"><span class="detail-key">Total perdu</span><span class="detail-val" style="color:var(--red)">-${(u.totalLost||0).toLocaleString('fr-FR')} FCFA</span></div>
    <div class="detail-row"><span class="detail-key">Meilleure s√©rie</span><span class="detail-val">${u.longestWinStreak||0} victoires</span></div>
    <div class="detail-row"><span class="detail-key">Inscription</span><span class="detail-val">${new Date(u.createdAt).toLocaleDateString('fr-FR')}</span></div>
    <div class="detail-row"><span class="detail-key">Statut</span><span class="detail-val">${u.banned?'<span style="color:var(--red)">BANNI</span>':u.vip?'<span style="color:var(--purple)">VIP</span>':'<span style="color:var(--green)">ACTIF</span>'}</span></div>
    <div style="margin-top:18px;display:flex;gap:10px;">
      <button class="action-btn ${u.banned?'unban':'ban'}" onclick="toggleBan('${u.username}',${!u.banned});closeModal();">${u.banned?'D√âBANNIR':'BANNIR'}</button>
      <button class="action-btn vip" onclick="toggleVIP('${u.username}');closeModal();">TOGGLE VIP</button>
    </div>
  `;
  document.getElementById('playerModal').classList.add('open');
}
function closeModal(){ document.getElementById('playerModal').classList.remove('open'); }

// ‚îÄ‚îÄ RTP ‚îÄ‚îÄ
let rtpData={};
function getRTPSettings(){ try{return JSON.parse(localStorage.getItem('poko_rtp')||'{}');}catch(e){return {};} }
function saveRTPSettings(d){ localStorage.setItem('poko_rtp',JSON.stringify(d)); }

async function renderRTP(){
  const users=await getUsersAsync().filter(u=>!u.banned);
  const saved=getRTPSettings();
  const container=document.getElementById('rtpPlayers');
  rtpData={};
  users.forEach(u=>{ rtpData[u.username]=saved[u.username]||50; });

  container.innerHTML=users.map(u=>{
    const val=rtpData[u.username];
    const cls=val>60?'rtp-val-good':val<35?'rtp-val-bad':'rtp-val-mid';
    const modeLabel=val>65?'üçÄ FAVORIS√â':val>50?'üìà AVANTAGE':val===50?'‚öñÔ∏è NEUTRE':val>30?'üìâ D√âSAVANTAG√â':'üíÄ RUIN√â';
    return `<div class="rtp-player-row" id="rtp-row-${u.username}">
      <div class="rtp-player-name">${u.avatar||'üÉè'} ${u.username}<span class="you-tag"></span></div>
      <div class="rtp-slider-wrap">
        <div class="rtp-label-row"><span>D√âFAVORIS√â</span><span>NEUTRE</span><span>FAVORIS√â</span></div>
        <input class="rtp-slider" type="range" min="5" max="95" value="${val}"
          style="--val:${val}%"
          oninput="updateRTP('${u.username}',this)">
      </div>
      <div class="rtp-val-display ${cls}" id="rtp-val-${u.username}">${val}%</div>
      <div class="rtp-mode-tag" id="rtp-mode-${u.username}" style="font-size:9px;color:var(--text-dim)">${modeLabel}</div>
    </div>`;
  }).join('') || '<div style="color:var(--text-dim);padding:20px;font-size:12px;">Aucun joueur enregistr√©.</div>';
}

function updateRTP(username, input){
  const v=parseInt(input.value);
  rtpData[username]=v;
  input.style.setProperty('--val',v+'%');
  const cls=v>60?'rtp-val-good':v<35?'rtp-val-bad':'rtp-val-mid';
  const el=document.getElementById('rtp-val-'+username);
  el.textContent=v+'%'; el.className='rtp-val-display '+cls;
  const modeLabel=v>65?'üçÄ FAVORIS√â':v>50?'üìà AVANTAGE':v===50?'‚öñÔ∏è NEUTRE':v>30?'üìâ D√âSAVANTAG√â':'üíÄ RUIN√â';
  document.getElementById('rtp-mode-'+username).textContent=modeLabel;
}

function applyGlobalPreset(mode, val){
  document.querySelectorAll('.rtp-preset').forEach(b=>b.classList.remove('on'));
  event.currentTarget.classList.add('on');
  Object.keys(rtpData).forEach(u=>{
    rtpData[u]=val;
    const row=document.getElementById('rtp-row-'+u);
    if(!row) return;
    const slider=row.querySelector('.rtp-slider');
    if(slider){ slider.value=val; slider.style.setProperty('--val',val+'%'); }
    const valEl=document.getElementById('rtp-val-'+u);
    if(valEl){ const cls=val>60?'rtp-val-good':val<35?'rtp-val-bad':'rtp-val-mid'; valEl.textContent=val+'%'; valEl.className='rtp-val-display '+cls; }
    const modeEl=document.getElementById('rtp-mode-'+u);
    if(modeEl){ const ml=val>65?'üçÄ FAVORIS√â':val>50?'üìà AVANTAGE':val===50?'‚öñÔ∏è NEUTRE':val>30?'üìâ D√âSAVANTAG√â':'üíÄ RUIN√â'; modeEl.textContent=ml; }
  });
}

function saveRTP(){
  saveRTPSettings(rtpData);
  addAdminLog('SYS','Param√®tres RTP mis √† jour');
  const msg=document.getElementById('rtpSaveMsg');
  msg.style.display='inline'; setTimeout(()=>msg.style.display='none',2500);
}

// ‚îÄ‚îÄ DIFFICULTY ‚îÄ‚îÄ
let currentDiff='easy';
const diffConfigs={
  easy:{casse:30,memory:20,aggro:20,delay:1200,label:'D√âBUTANT'},
  mid:{casse:60,memory:50,aggro:40,delay:900,label:'NORMAL'},
  hard:{casse:85,memory:85,aggro:70,delay:600,label:'EXPERT'},
  god:{casse:100,memory:100,aggro:90,delay:400,label:'DIVIN'}
};
function selectDiff(d){
  currentDiff=d;
  document.querySelectorAll('.diff-card').forEach(c=>c.classList.remove('selected'));
  event.currentTarget.classList.add('selected');
  const cfg=diffConfigs[d];
  document.getElementById('pCasse').value=cfg.casse; document.getElementById('pCasseVal').textContent=cfg.casse+'%';
  document.getElementById('pMemory').value=cfg.memory; document.getElementById('pMemoryVal').textContent=cfg.memory+'%';
  document.getElementById('pAggro').value=cfg.aggro; document.getElementById('pAggroVal').textContent=cfg.aggro+'%';
  document.getElementById('pDelay').value=cfg.delay; document.getElementById('pDelayVal').textContent=cfg.delay+'ms';
  document.getElementById('diffParamsLabel').textContent=cfg.label;
}
function updateParam(el,valId,suffix='%'){ document.getElementById(valId).textContent=el.value+suffix; }
function saveDifficulty(){
  const cfg={
    level:currentDiff,
    casse:parseInt(document.getElementById('pCasse').value),
    memory:parseInt(document.getElementById('pMemory').value),
    aggro:parseInt(document.getElementById('pAggro').value),
    delay:parseInt(document.getElementById('pDelay').value)
  };
  localStorage.setItem('poko_difficulty',JSON.stringify(cfg));
  addAdminLog('SYS',`Difficult√© IA : ${diffConfigs[currentDiff].label} sauvegard√©e`);
  const msg=document.getElementById('diffSaveMsg');
  msg.style.display='inline'; setTimeout(()=>msg.style.display='none',2500);
}
// Load saved difficulty
(()=>{ try{ const s=JSON.parse(localStorage.getItem('poko_difficulty')||'null'); if(s&&s.level){ currentDiff=s.level; document.querySelectorAll('.diff-card').forEach(c=>c.classList.remove('selected')); document.querySelector('.diff-card.d-'+({'easy':'easy','mid':'mid','hard':'hard','god':'god'}[s.level]||'easy')).classList.add('selected'); const cfg=diffConfigs[s.level]; document.getElementById('pCasse').value=s.casse||cfg.casse; document.getElementById('pCasseVal').textContent=(s.casse||cfg.casse)+'%'; document.getElementById('pMemory').value=s.memory||cfg.memory; document.getElementById('pMemoryVal').textContent=(s.memory||cfg.memory)+'%'; document.getElementById('pAggro').value=s.aggro||cfg.aggro; document.getElementById('pAggroVal').textContent=(s.aggro||cfg.aggro)+'%'; document.getElementById('pDelay').value=s.delay||cfg.delay; document.getElementById('pDelayVal').textContent=(s.delay||cfg.delay)+'ms'; document.getElementById('diffParamsLabel').textContent=diffConfigs[s.level].label; } }catch(e){} })();

// ‚îÄ‚îÄ LOGS ‚îÄ‚îÄ
let logFilter='all';
async function renderLogs(){
  const logs=getAdminLogs();
  const users=await getUsersAsync();
  // Merge with player transactions
  // Fetch recent transactions from Supabase
  try{
    const recentTx=await SB.get('poko_transactions','order=date.desc&limit=100');
    (recentTx||[]).forEach(tx=>{
      const type=tx.type==='win'?'WIN':tx.type==='loss'?'LOSE':tx.type==='deposit'?'JOIN':'SYS';
      logs.push({ts:tx.date,type,msg:`${tx.username} ‚Äî ${tx.label}`});
    });
  }catch(e){}
  users.forEach(u=>(u.transactions||[]).slice(0,5).forEach(tx=>{
    const type=tx.type==='win'?'WIN':tx.type==='loss'?'LOSE':tx.type==='deposit'?'JOIN':'SYS';
    logs.push({ts:tx.date,type,msg:`${u.username} ‚Äî ${tx.label}`});
  }));
  }catch(e){}
  logs.sort((a,b)=>b.ts-a.ts);
  const filtered=logFilter==='all'?logs:logs.filter(l=>l.type===logFilter);
  const term=document.getElementById('logTerminal');
  term.innerHTML=filtered.slice(0,150).map(l=>`
    <div class="log-line">
      <span class="log-ts">${new Date(l.ts).toLocaleString('fr-FR',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}</span>
      <span class="log-type ${l.type}">${l.type}</span>
      <span class="log-msg">${l.msg}</span>
    </div>
  `).join('') || '<div style="color:var(--text-dim);padding:10px;">Aucun log disponible</div>';
  term.scrollTop=0;
}
function filterLog(f,btn){
  logFilter=f;
  document.querySelectorAll('.log-filter').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderLogs();
}
function clearLogs(){ localStorage.removeItem('poko_admin_logs'); renderLogs(); }

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ
function loadSettings(){
  const s=getAdminSettings();
  if(s.minBet) document.getElementById('cfg-minBet').value=s.minBet;
  if(s.maxBet) document.getElementById('cfg-maxBet').value=s.maxBet;
  if(s.welcomeBonus) document.getElementById('cfg-welcomeBonus').value=s.welcomeBonus;
  if(s.dailyBonus) document.getElementById('cfg-dailyBonus').value=s.dailyBonus;
  if(s.register!==undefined) document.getElementById('cfg-register').checked=s.register;
  if(s.kin!==undefined) document.getElementById('cfg-kin').checked=s.kin;
  if(s.showLog!==undefined) document.getElementById('cfg-showLog').checked=s.showLog;
  if(s.anims!==undefined) document.getElementById('cfg-anims').checked=s.anims;
}
function saveSettings(){
  const s={
    minBet:parseInt(document.getElementById('cfg-minBet').value)||50,
    maxBet:parseInt(document.getElementById('cfg-maxBet').value)||10000,
    welcomeBonus:parseInt(document.getElementById('cfg-welcomeBonus').value)||5000,
    dailyBonus:parseInt(document.getElementById('cfg-dailyBonus').value)||500,
    register:document.getElementById('cfg-register').checked,
    kin:document.getElementById('cfg-kin').checked,
    showLog:document.getElementById('cfg-showLog').checked,
    anims:document.getElementById('cfg-anims').checked
  };
  saveAdminSettings(s);
  addAdminLog('SYS','Param√®tres globaux mis √† jour');
  const msg=document.getElementById('settingsSaveMsg');
  msg.style.display='inline'; setTimeout(()=>msg.style.display='none',2500);
}


// ‚îÄ‚îÄ CAISSE CASINO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function getCaisseState(){
  try{ return JSON.parse(localStorage.getItem('poko_caisse')||'null') || {solde:0,totalEncaisse:0,totalDecaisse:0,totalEmis:0,ledger:[]}; }
  catch(e){ return {solde:0,totalEncaisse:0,totalDecaisse:0,totalEmis:0,ledger:[]}; }
}
function saveCaisseState(c){ localStorage.setItem('poko_caisse',JSON.stringify(c)); }

// Reconstruct caisse from player transactions (source of truth)
function computeCaisse(){
  const users = getUsers();
  let totalEncaisse=0, totalDecaisse=0, totalEmis=0;
  const ledger=[];

  users.forEach(u=>{
    (u.transactions||[]).forEach(tx=>{
      if(tx.type==='loss'){
        totalEncaisse += Math.abs(tx.amount);
        ledger.push({ts:tx.date, user:u.username, label:tx.label, amount:Math.abs(tx.amount), dir:'in', balance:tx.balance||0});
      } else if(tx.type==='win'){
        totalDecaisse += Math.abs(tx.amount);
        ledger.push({ts:tx.date, user:u.username, label:tx.label, amount:-Math.abs(tx.amount), dir:'out', balance:tx.balance||0});
      } else if(tx.type==='bonus'){
        totalEmis += Math.abs(tx.amount);
        ledger.push({ts:tx.date, user:u.username, label:tx.label, amount:tx.amount, dir:'emit', balance:tx.balance||0});
      } else if(tx.type==='deposit'){
        ledger.push({ts:tx.date, user:u.username, label:tx.label, amount:tx.amount, dir:'emit', balance:tx.balance||0});
        totalEmis += Math.abs(tx.amount);
      }
    });
  });

  ledger.sort((a,b)=>b.ts-a.ts);
  const solde = totalEncaisse - totalDecaisse;
  return {solde, totalEncaisse, totalDecaisse, totalEmis, marge:solde, ledger};
}

function fmt(n){ return Math.abs(n).toLocaleString('fr-FR'); }
function fmtSigned(n){ return (n>=0?'+':'-')+fmt(n)+' FCFA'; }

let cfDays = 0; // 0 = all

async function renderCaisse(){
  await getUsersAsync();
  const c = computeCaisse();
  const users = getUsers();

  // Hero
  document.getElementById('caisseSoldeVal').textContent = c.solde.toLocaleString('fr-FR')+' FCFA';
  document.getElementById('caisseSoldeVal').style.color = c.solde >= 0 ? 'var(--amber)' : 'var(--red)';
  document.getElementById('caisseEncaisse').textContent = '+'+fmt(c.totalEncaisse)+' FCFA';
  document.getElementById('caisseDecaisse').textContent = '-'+fmt(c.totalDecaisse)+' FCFA';
  document.getElementById('caisseEmise').textContent = fmt(c.totalEmis)+' FCFA';
  const marge = c.totalEncaisse > 0 ? Math.round(c.solde/c.totalEncaisse*100) : 0;
  document.getElementById('caisseMarge').textContent = marge+'%';
  document.getElementById('caisseMarge').style.color = marge>=0?'var(--green)':'var(--red)';

  // KPIs
  const nbGames = users.reduce((a,u)=>a+(u.totalGames||0),0);
  const nbWins  = users.reduce((a,u)=>a+(u.totalWins||0),0);
  const houseEdge = nbGames>0 ? Math.round((1-(nbWins/nbGames))*100) : 0;
  const avgBet = nbGames>0 ? Math.round(c.totalEncaisse/nbGames) : 0;
  document.getElementById('caisseKpi').innerHTML=`
    <div class="kpi green"><div class="kpi-label">Pertes joueurs (revenus)</div><div class="kpi-val">${fmt(c.totalEncaisse)}</div><div class="kpi-sub">FCFA encaiss√©s</div></div>
    <div class="kpi red"><div class="kpi-label">Gains vers√©s aux joueurs</div><div class="kpi-val">${fmt(c.totalDecaisse)}</div><div class="kpi-sub">FCFA d√©caiss√©s</div></div>
    <div class="kpi"><div class="kpi-label">Solde net casino</div><div class="kpi-val" style="color:${c.solde>=0?'var(--amber)':'var(--red)'}">${c.solde>=0?'+':''}${fmt(c.solde)}</div><div class="kpi-sub">B√©n√©fice brut</div></div>
    <div class="kpi blue"><div class="kpi-label">House Edge moyen</div><div class="kpi-val">${houseEdge}%</div><div class="kpi-sub">Avantage casino</div></div>
    <div class="kpi" style="--c:var(--purple)"><div class="kpi-label">Monnaie virtuelle √©mise</div><div class="kpi-val" style="color:var(--purple)">${fmt(c.totalEmis)}</div><div class="kpi-sub">Bonus + d√©p√¥ts inject√©s</div></div>
    <div class="kpi blue"><div class="kpi-label">Mise moyenne/partie</div><div class="kpi-val">${avgBet.toLocaleString('fr-FR')}</div><div class="kpi-sub">FCFA</div></div>
  `;

  // Populate emit target select
  const sel = document.getElementById('emitTarget');
  const cur = sel.value;
  sel.innerHTML = '<option value="all">Tous les joueurs actifs</option>' +
    users.filter(u=>!u.banned).map(u=>`<option value="${u.username}">${u.avatar||'üÉè'} ${u.username} ‚Äî ${(u.balance||0).toLocaleString('fr-FR')} FCFA</option>`).join('');
  if(cur) sel.value=cur;

  // Cash flow list
  renderCashFlow(c.ledger);

  // P&L table
  const tbody = document.getElementById('pnlTbody');
  const pnlData = users.map(u=>{
    let enc=0,dec=0,bonus=0;
    (u.transactions||[]).forEach(tx=>{
      if(tx.type==='loss') enc+=Math.abs(tx.amount);
      else if(tx.type==='win') dec+=Math.abs(tx.amount);
      else if(tx.type==='bonus'||tx.type==='deposit') bonus+=Math.abs(tx.amount);
    });
    const pnl = enc - dec;
    return {u, enc, dec, bonus, pnl};
  }).sort((a,b)=>b.pnl-a.pnl);

  tbody.innerHTML = pnlData.map(({u,enc,dec,bonus,pnl})=>`<tr>
    <td>${u.avatar||'üÉè'} <strong style="color:var(--text)">${u.username}</strong></td>
    <td style="color:var(--green)">+${fmt(enc)} FCFA</td>
    <td style="color:var(--red)">-${fmt(dec)} FCFA</td>
    <td style="color:var(--amber)">${fmt(enc)} FCFA</td>
    <td style="color:var(--blue)">${fmt(bonus)} FCFA</td>
    <td class="${pnl>=0?'pnl-pos':'pnl-neg'}">${pnl>=0?'+':''}${fmt(pnl)} FCFA</td>
    <td>${pnl>0
      ? '<span class="pnl-badge winner">PROFITABLE</span>'
      : pnl<0 ? '<span class="pnl-badge loser">GAGNANT</span>'
      : '<span class="pnl-badge even">NEUTRE</span>'}</td>
  </tr>`).join('') || '<tr><td colspan="7" style="text-align:center;color:var(--text-dim);padding:30px;">Aucune donn√©e</td></tr>';

  // Grand livre
  document.getElementById('ledgerCount').textContent = c.ledger.length + ' entr√©es';
  const ll = document.getElementById('ledgerList');
  ll.innerHTML = c.ledger.slice(0,100).map(e=>`
    <div class="ledger-row">
      <div class="ledger-ts">${new Date(e.ts).toLocaleDateString('fr-FR',{day:'2-digit',month:'short',hour:'2-digit',minute:'2-digit'})}</div>
      <div class="ledger-user">${e.user}</div>
      <div class="ledger-label">${e.label}</div>
      <div class="ledger-amt ${e.dir==='in'?'pos':e.dir==='out'?'neg':'neutral'}">${e.dir==='in'?'+':e.dir==='out'?'-':''}${fmt(Math.abs(e.amount))} FCFA</div>
      <div class="ledger-balance">Solde: ${(e.balance||0).toLocaleString('fr-FR')} FCFA</div>
    </div>
  `).join('') || '<div style="color:var(--text-dim);padding:20px;text-align:center;">Aucune transaction</div>';
}

function renderCashFlow(ledger){
  const now = Date.now();
  let filtered = ledger;
  if(cfDays>0){ const cutoff=now-cfDays*864e5; filtered=ledger.filter(e=>e.ts>=cutoff); }
  const list = document.getElementById('cashFlowList');
  list.innerHTML = filtered.slice(0,40).map(e=>`
    <div class="cf-row">
      <div class="cf-type ${e.dir}"></div>
      <div class="cf-date">${new Date(e.ts).toLocaleDateString('fr-FR',{day:'2-digit',month:'short'})}</div>
      <div class="cf-label">${e.user} ‚Äî ${e.label}</div>
      <div class="cf-amount ${e.dir==='in'?'pos':e.dir==='out'?'neg':'neutral'}">
        ${e.dir==='in'?'+':e.dir==='out'?'-':''}${fmt(Math.abs(e.amount))} FCFA
      </div>
    </div>
  `).join('') || '<div style="color:var(--text-dim);padding:16px;font-size:11px;">Aucun flux sur cette p√©riode</div>';
}

function setCFPeriod(days, btn){
  cfDays = days;
  document.querySelectorAll('#cf7,#cf30,#cfAll').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('cfPeriod').textContent = days===7?'7 DERNIERS JOURS':days===30?'30 DERNIERS JOURS':'TOUT';
  const c = computeCaisse();
  renderCashFlow(c.ledger);
}

function setEmit(v){ document.getElementById('emitAmount').value=v; }

async function emitMoney(){
  const amount = parseInt(document.getElementById('emitAmount').value)||0;
  const target = document.getElementById('emitTarget').value;
  const msg = document.getElementById('emitMsg');
  if(amount<=0){ msg.style.display='block'; msg.style.color='var(--red)'; msg.textContent='Montant invalide.'; return; }

  const usersRaw = JSON.parse(localStorage.getItem('poko_users')||'{}');
  const now = Date.now();
  let count=0;

  Object.values(usersRaw).forEach(u=>{
    if(u.banned) return;
    if(target!=='all' && u.username!==target) return;
    u.balance = (u.balance||0) + amount;
    u.transactions = u.transactions||[];
    u.transactions.unshift({id:now+count, type:'bonus', amount, label:'üíµ Injection casino ‚Äî '+amount.toLocaleString('fr-FR')+' FCFA', date:now+count, balance:u.balance});
    if(u.transactions.length>100) u.transactions=u.transactions.slice(0,100);
    count++;
  });

  localStorage.setItem('poko_users', JSON.stringify(usersRaw));
  addAdminLog('SYS', '√âmission '+amount.toLocaleString('fr-FR')+' FCFA ‚Üí '+(target==='all'?'Tous les joueurs':target)+' ('+count+' compte(s))');

  msg.style.display='block';
  msg.style.color='var(--green)';
  msg.textContent='‚úì '+amount.toLocaleString('fr-FR')+' FCFA √©mis vers '+(target==='all'?count+' joueur(s)':target)+' avec succ√®s.';
  setTimeout(()=>{ msg.style.display='none'; }, 4000);
  renderCaisse();
}


// ‚îÄ‚îÄ TRANSFERT DE DONN√âES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function renderDataTransfer(){
  const users = getUsers();
  const rtp = getRTPSettings();
  const diff = (()=>{ try{return JSON.parse(localStorage.getItem('poko_difficulty')||'null');}catch(e){return null;} })();
  const settings = getAdminSettings();
  const logs = getAdminLogs();

  document.getElementById('exportSummary').innerHTML = `
    <div style="color:var(--amber);">üì¶ Contenu de l'export :</div>
    <div>üë• Joueurs : <strong style="color:var(--text)">${users.length}</strong></div>
    <div>üé∞ Profils RTP : <strong style="color:var(--text)">${Object.keys(rtp).length}</strong></div>
    <div>ü§ñ Difficult√© IA : <strong style="color:var(--text)">${diff?diff.level.toUpperCase():'Non d√©finie'}</strong></div>
    <div>üìã Logs admin : <strong style="color:var(--text)">${logs.length}</strong></div>
    <div>‚öôÔ∏è Param√®tres : <strong style="color:var(--text)">Inclus</strong></div>
  `;
}

function exportData(){
  const payload = {
    version: '1.0',
    exportedAt: new Date().toISOString(),
    poko_users:      localStorage.getItem('poko_users')      || '{}',
    poko_rtp:        localStorage.getItem('poko_rtp')        || '{}',
    poko_difficulty: localStorage.getItem('poko_difficulty') || 'null',
    poko_admin_settings: localStorage.getItem('poko_admin_settings') || '{}',
    poko_admin_logs: localStorage.getItem('poko_admin_logs') || '[]',
    poko_subprofiles:localStorage.getItem('poko_subprofiles')|| '[]',
    poko_caisse:     localStorage.getItem('poko_caisse')     || 'null',
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'poko_data_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  addAdminLog('SYS', 'Export de donn√©es effectu√©');
}

let _importPayload = null;
function previewImport(input){
  const file = input.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      _importPayload = data;
      const users = Object.values(JSON.parse(data.poko_users||'{}')).length;
      const rtp = Object.keys(JSON.parse(data.poko_rtp||'{}')).length;
      const diff = JSON.parse(data.poko_difficulty||'null');
      const logs = JSON.parse(data.poko_admin_logs||'[]').length;
      document.getElementById('importPreview').style.display='block';
      document.getElementById('importPreview').innerHTML = `
        <div style="color:var(--green);">‚úì Fichier valide ‚Äî export√© le ${data.exportedAt?new Date(data.exportedAt).toLocaleString('fr-FR'):'date inconnue'}</div>
        <div>üë• Joueurs : <strong style="color:var(--text)">${users}</strong></div>
        <div>üé∞ Profils RTP : <strong style="color:var(--text)">${rtp}</strong></div>
        <div>ü§ñ Difficult√© : <strong style="color:var(--text)">${diff?diff.level.toUpperCase():'Non d√©finie'}</strong></div>
        <div>üìã Logs : <strong style="color:var(--text)">${logs}</strong></div>
      `;
      document.getElementById('importBtn').style.display='block';
    } catch(err) {
      document.getElementById('importPreview').style.display='block';
      document.getElementById('importPreview').innerHTML = '<span style="color:var(--red)">‚ùå Fichier JSON invalide.</span>';
      document.getElementById('importBtn').style.display='none';
    }
  };
  reader.readAsText(file);
}

function importData(){
  if(!_importPayload){ return; }
  const keys = ['poko_users','poko_rtp','poko_difficulty','poko_admin_settings','poko_admin_logs','poko_subprofiles','poko_caisse'];
  keys.forEach(k=>{ if(_importPayload[k] !== undefined) localStorage.setItem(k, _importPayload[k]); });
  addAdminLog('SYS','Import de donn√©es effectu√©');
  const msg = document.getElementById('importMsg');
  msg.style.display='block'; msg.style.color='var(--green)';
  msg.textContent='‚úì Donn√©es import√©es avec succ√®s. Rechargement...';
  setTimeout(()=>location.reload(), 1500);
}

function injectDemoData(){
  const now = Date.now();
  const demoUsers = {
    'MAKOSSO': {
      username:'MAKOSSO', email:'makosso@poko.cg', avatar:'ü¶Å',
      password: btoa('demo123'), balance:12500,
      totalGames:28, totalWins:14, totalEarned:18000, totalLost:8500,
      longestWinStreak:5, currentStreak:2, banned:false, vip:true,
      createdAt: now - 30*864e5, lastLogin: now - 864e5,
      transactions:[
        {id:1,type:'win',amount:2000,label:'üèÜ Victoire ‚Äî gain 2000 FCFA',date:now-3600e3,balance:12500},
        {id:2,type:'loss',amount:-500,label:'üíÄ D√©faite ‚Äî mise perdue',date:now-7200e3,balance:10500},
        {id:3,type:'deposit',amount:5000,label:'üí≥ D√©p√¥t simul√©',date:now-864e5,balance:11000},
        {id:4,type:'bonus',amount:500,label:'‚òÄÔ∏è Bonus quotidien',date:now-2*864e5,balance:6000},
      ]
    },
    'NGANGA': {
      username:'NGANGA', email:'nganga@poko.cg', avatar:'üêØ',
      password: btoa('demo123'), balance:4200,
      totalGames:15, totalWins:4, totalEarned:5000, totalLost:12000,
      longestWinStreak:2, currentStreak:0, banned:false, vip:false,
      createdAt: now - 15*864e5, lastLogin: now - 2*864e5,
      transactions:[
        {id:5,type:'loss',amount:-1000,label:'üíÄ D√©faite ‚Äî mise perdue',date:now-864e5,balance:4200},
        {id:6,type:'win',amount:3000,label:'üèÜ Victoire ‚Äî gain 3000 FCFA',date:now-3*864e5,balance:5200},
        {id:7,type:'bonus',amount:5000,label:'üéÅ Bonus bienvenue',date:now-15*864e5,balance:5000},
      ]
    },
    'MBOUNGOU': {
      username:'MBOUNGOU', email:'mboungou@poko.cg', avatar:'üé≠',
      password: btoa('demo123'), balance:800,
      totalGames:42, totalWins:8, totalEarned:9000, totalLost:22000,
      longestWinStreak:3, currentStreak:0, banned:false, vip:false,
      createdAt: now - 60*864e5, lastLogin: now - 5*864e5,
      transactions:[
        {id:8,type:'loss',amount:-2000,label:'üíÄ D√©faite ‚Äî mise perdue',date:now-5*864e5,balance:800},
        {id:9,type:'loss',amount:-1000,label:'üíÄ D√©faite ‚Äî mise perdue',date:now-6*864e5,balance:2800},
        {id:10,type:'deposit',amount:3000,label:'üí≥ D√©p√¥t simul√©',date:now-7*864e5,balance:3800},
      ]
    },
    'LOUBAKI': {
      username:'LOUBAKI', email:'loubaki@poko.cg', avatar:'üÉè',
      password: btoa('demo123'), balance:0,
      totalGames:5, totalWins:0, totalEarned:0, totalLost:5000,
      longestWinStreak:0, currentStreak:0, banned:true, vip:false,
      createdAt: now - 5*864e5, lastLogin: now - 4*864e5,
      transactions:[
        {id:11,type:'loss',amount:-1000,label:'üíÄ D√©faite ‚Äî mise perdue',date:now-4*864e5,balance:0},
        {id:12,type:'bonus',amount:5000,label:'üéÅ Bonus bienvenue',date:now-5*864e5,balance:5000},
      ]
    }
  };

  localStorage.setItem('poko_users', JSON.stringify(demoUsers));
  localStorage.setItem('poko_rtp', JSON.stringify({MAKOSSO:65,NGANGA:45,MBOUNGOU:30,LOUBAKI:50}));
  localStorage.setItem('poko_difficulty', JSON.stringify({level:'mid',casse:60,memory:50,aggro:40,delay:900}));
  addAdminLog('SYS','Donn√©es de d√©monstration inject√©es (4 joueurs)');

  const msg = document.getElementById('demoMsg');
  msg.style.display='inline'; msg.style.color='var(--green)';
  msg.textContent='‚úì 4 joueurs de d√©mo cr√©√©s. Rechargement...';
  setTimeout(()=>location.reload(), 1200);
}

function clearAllData(){
  if(!confirm('‚ö†Ô∏è Supprimer TOUTES les donn√©es (joueurs, logs, param√®tres) ?')) return;
  ['poko_users','poko_rtp','poko_difficulty','poko_admin_settings','poko_admin_logs','poko_subprofiles','poko_caisse'].forEach(k=>localStorage.removeItem(k));
  location.reload();
}

// ‚îÄ‚îÄ SOUS-PROFILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function getSPs(){ try{return JSON.parse(localStorage.getItem('poko_subprofiles')||'[]');}catch(e){return[];} }
function saveSPs(l){ localStorage.setItem('poko_subprofiles',JSON.stringify(l)); }

// Check if logged in via subprofile and restrict nav
(function restrictSubProfile(){
  const spUser = sessionStorage.getItem('poko_admin_sub');
  if(!spUser) return;
  const sps = getSPs();
  const sp = sps.find(s=>s.user===spUser);
  if(!sp) return;
  // Hide nav items not in perms
  const allModules = ['dashboard','players','rtp','difficulty','logs','caisse','subprofiles','settings'];
  allModules.forEach(mod=>{
    if(!sp.perms.includes(mod)){
      document.querySelectorAll('.nav-item').forEach(n=>{
        if(n.getAttribute('onclick')&&n.getAttribute('onclick').includes("'"+mod+"'")){
          n.style.display='none';
        }
      });
    }
  });
  // Show "restricted" badge
  const logo = document.querySelector('.sidebar-logo');
  if(logo){
    const badge=document.createElement('div');
    badge.style.cssText='font-size:8px;letter-spacing:2px;color:var(--amber);margin-top:4px;padding:3px 8px;background:var(--amber-dim);border:1px solid rgba(230,57,70,.3);';
    badge.textContent='ACC√àS: '+sp.role.toUpperCase();
    logo.appendChild(badge);
  }
})();

function renderSubProfiles(){
  const sps = getSPs();
  const list = document.getElementById('sp-list');
  document.getElementById('sp-count').textContent = sps.length + ' profil(s)';
  if(!list) return;
  const perm_labels = {dashboard:'üìä',players:'üë•',rtp:'üé∞',difficulty:'ü§ñ',logs:'üìã',caisse:'üíµ',settings:'‚öôÔ∏è'};
  list.innerHTML = sps.length===0
    ? '<div style="color:var(--text-dim);font-size:11px;padding:16px;text-align:center;">Aucun sous-profil cr√©√©</div>'
    : sps.map((sp,i)=>`
      <div style="background:rgba(230,57,70,.05);border:1px solid var(--border);padding:14px 16px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <div>
            <div style="font-size:13px;color:var(--text);font-weight:700;">${sp.user}</div>
            <div style="font-size:9px;color:var(--text-dim);letter-spacing:2px;margin-top:2px;">${sp.role||'SUPERVISEUR'} ¬∑ Cr√©√© le ${new Date(sp.created).toLocaleDateString('fr-FR')}</div>
          </div>
          <button class="action-btn ban" onclick="deleteSP(${i})">SUPPRIMER</button>
        </div>
        <div style="display:flex;gap:4px;flex-wrap:wrap;">
          ${sp.perms.map(p=>`<span style="font-size:9px;padding:2px 6px;background:var(--amber-dim);color:var(--amber);border:1px solid rgba(230,57,70,.25);">${perm_labels[p]||'?'} ${p}</span>`).join('')}
        </div>
      </div>
    `).join('');
}

function createSubProfile(){
  const user = document.getElementById('sp-user').value.trim();
  const pass = document.getElementById('sp-pass').value;
  const perms = [...document.querySelectorAll('#sp-perms input[name="perm"]:checked')].map(c=>c.value);
  const msg = document.getElementById('sp-msg');

  if(!user||!pass){ msg.style.display='block';msg.style.color='var(--red)';msg.textContent='Remplis tous les champs.';return; }
  if(perms.length===0){ msg.style.display='block';msg.style.color='var(--red)';msg.textContent='S√©lectionne au moins un acc√®s.';return; }

  const sps = getSPs();
  if(sps.find(s=>s.user===user)){ msg.style.display='block';msg.style.color='var(--red)';msg.textContent='Cet identifiant existe d√©j√†.';return; }

  sps.push({ user, pass: btoa(pass), perms, role:'Superviseur', created: Date.now() });
  saveSPs(sps);
  addAdminLog('SYS','Sous-profil cr√©√© : '+user+' ('+perms.join(',')+')');

  document.getElementById('sp-user').value='';
  document.getElementById('sp-pass').value='';
  msg.style.display='block'; msg.style.color='var(--green)';
  msg.textContent='‚úì Sous-profil "'+user+'" cr√©√© avec succ√®s.';
  setTimeout(()=>msg.style.display='none',3000);
  renderSubProfiles();
}

function deleteSP(i){
  const sps=getSPs(); sps.splice(i,1); saveSPs(sps);
  addAdminLog('SYS','Sous-profil supprim√©');
  renderSubProfiles();
}

// Init subprofiles panel on load
document.addEventListener('DOMContentLoaded',()=>{ renderSubProfiles(); });
setTimeout(()=>renderSubProfiles(),100);

function adminLogout(){ sessionStorage.removeItem('poko_admin'); sessionStorage.removeItem('poko_admin_sub'); window.location.href='admin-login.html'; }

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
(async()=>{ await renderDashboard(); loadSettings(); })();
</script>
</body>
</html>
